#vim server_ext.cnf

[ req ]
default_bits       = 2048
prompt             = no
default_md         = sha256
distinguished_name = dn
req_extensions     = v3_req

[ dn ]
C  = BR
ST = RS
L  = Bage
O  = PampaComputing
CN = 192.168.0.102

[ v3_req ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = localhost
IP.1  = 127.0.0.1
IP.2  = 192.168.0.102


#bash
bash generate-certs.sh
content:
#!/usr/bin/env bash
set -euo pipefail
export MSYS_NO_PATHCONV=1
export MSYS2_ARG_CONV_EXCL="*"
cd "$(dirname "$0")"

IP="192.168.0.102"
ORG="PampaComputing"
TLS_DIR="../tls"
mkdir -p "$TLS_DIR/ca"

# 1) Create a tiny CA extensions file
cat > ca_ext.cnf <<EOF
[ v3_ca ]
basicConstraints       = critical,CA:true
keyUsage               = critical, digitalSignature, keyCertSign, cRLSign
subjectKeyIdentifier   = hash
EOF

# 2) Generate the CA private key
openssl genrsa -out "$TLS_DIR/ca/ca.key" 4096

# 3) Create a CSR for the CA (no SANs needed)
openssl req -new \
  -key    "$TLS_DIR/ca/ca.key" \
  -subj   "/C=BR/ST=RS/L=Bage/O=$ORG/OU=CA/CN=MyLocalCA" \
  -out    ca.csr

# 4) Self-sign the CA cert WITH the v3_ca extensions
openssl x509 -req \
  -in       ca.csr \
  -signkey  "$TLS_DIR/ca/ca.key" \
  -days     3650 \
  -sha256   \
  -extfile  ca_ext.cnf \
  -extensions v3_ca \
  -out      "$TLS_DIR/ca/ca.crt"

# 5) Clean up
rm -v ca.csr ca_ext.cnf

echo "âœ… CA key and cert with CA:true + keyCertSign are in $TLS_DIR/ca"


#bash
# 1) Generate a fresh server private key
openssl genrsa -out server.key 2048

# 2) Build the CSR using your new server_ext.cnf
openssl req -new \
  -key    server.key \
  -out    server.csr \
  -config server_ext.cnf

# 3) Sign the CSR with your CA (which now has keyCertSign enabled)
openssl x509 -req \
  -in       server.csr \
  -CA       ../tls/ca/ca.crt \
  -CAkey    ../tls/ca/ca.key \
  -CAcreateserial \
  -out      server.crt \
  -days     825 \
  -sha256   \
  -extfile  server_ext.cnf \
  -extensions v3_req

# 4) Move the final cert/key into your tls/ folder
mv server.crt server.key ../tls/

# 5) (Optional) Clean up intermediates
rm server.csr *.srl
